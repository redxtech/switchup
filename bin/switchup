#!/usr/bin/env sh

# script name: switchup
# description: a command line tool for downloading and preparing SD cards for modded switches
# usage: switchup [<options>]
# dependencies: gh, unzip, p7zip, curl

# download a file from a repo's releases
ghr() {
	repo="$1"
	pattern="$2"
	output="$3"
	release="$4"

	if test -z "$release"; then
		gh release download --repo "$repo" --output "$output" --pattern "$pattern"
	else
		gh release download "$release" --repo "$repo" --output "$output" --pattern "$pattern"
	fi
}

main() {
	# default option values
	cflag=1
	dflag=1
	eflag=
	fflag=1
	gflag=1
	hflag=
	kflag=1
	lflag=1
	nflag=1
	rflag=
	tflag=1
	wflag=1
	zflag=

	# handle getting options from the command line
	while getopts 'cdefghklnrtwz' OPTION; do
		case $OPTION in
		c)
			cflag=
			;;
		d)
			dflag=
			;;
		e)
			eflag=1
			;;
		f)
			fflag=
			;;
		g)
			gflag=
			;;
		h)
			hflag=1
			;;
		k)
			kflag=
			;;
		l)
			lflag=
			;;
		n)
			nflag=
			;;
		r)
			rflag=1
			;;
		t)
			tflag=
			;;
		w)
			wflag=
			;;
		z)
			zflag=1
			;;
		?)
			printf "Usage: %s [options]
      -c: skip cleanup
      -d: omit DBI
      -e: include emuNAND
      -f: omit fastCFWswitch
      -g: omit Goldleaf
      -h: include HDR
      -k: keep folder (if zipping)
      -l: omit Lockpick_RCM
      -n: omit Tinfoil
      -r: include RetroArch
      -t: omit Training Mod
      -w: omit WiFi Latency Mod
      -z: output a zip\n" "$(basename "$0")" >&2
			exit 2
			;;
		esac
	done

	# decide file names
	filename="SwitchUp_"

	if test "$tflag"; then
		filename="${filename}Training+"
	fi
	if test "$wflag"; then
		filename="${filename}WiFi+"
	fi
	if test "$hflag"; then
		filename="${filename}HDR+"
	fi
	if test "$eflag"; then
		filename="${filename}emuNAND+"
	fi
	if test "$rflag"; then
		filename="${filename}RetroArch+"
	fi
	if test "$dflag"; then
		filename="${filename}D"
	fi
	if test "$gflag"; then
		filename="${filename}G"
	fi
	if test "$nflag"; then
		filename="${filename}N"
	fi
	if test "$fflag"; then
		filename="${filename}F"
	fi
	if test "$lflag"; then
		filename="${filename}L"
	fi
	if test "$dflag" || test "$gflag" || test "$fflag" || test "$lflag"; then
		filename="${filename}_"
	fi

	filename="$filename$(date "+%Y-%m-%d_%R")"

	# set remote urls
	atmosphere="Atmosphere-NX/Atmosphere"
	hekate="CTCaer/hekate"
	sigpatches="https://sigmapatches.coomer.party/sigpatches.zip"
	dbi="rashevskyv/dbi"
	goldleaf="XorTroll/Goldleaf"
	tinfoil="http://tinfoil.media/repo/Tinfoil%20Self%20Installer%20%5B050000BADDAD0000%5D%5B16.0%5D%5Bv0%5D.zip"
	lockpick="shchmue/Lockpick_RCM"
	tesla="WerWolv/Tesla-Menu"
	ovlloader="WerWolv/nx-ovlloader"
	fastcfwswitch="Hartie95/fastCFWswitch"
	skyline="skyline-dev/skyline"
	arcropolis="Raytwo/ARCropolis"
	wifi="blu-dev/arena-latency-slider"
	training="jugeeya/UltimateTrainingModpack"
	mods_drive="https://drive.google.com/uc?export=download&id=1GO7i5Z7D6I9EzqaZr3d9JbNiOa11QuNf"
	mods_zip="$HOME/Documents/Switch/resources/mods.zip"
	hdr="HDR-Development/HDR-Releases"
	smashline="blu-dev/smashline_hook"
	retroarch="https://buildbot.libretro.com/stable/1.15.0/nintendo/switch/libnx/RetroArch.7z"

	# folder names
	tmpdir=".gen_switch"
	out="$tmpdir/root"
	smash_dir="$out/atmosphere/contents/01006A800016E000"
	resource_dir="$(dirname "$0")/../resources"

	# clean out the folder
	if test -d "$tmpdir"; then
		rm -r "$tmpdir"
	fi

	# create the temp folder
	mkdir -p "$out"

	# start with atmosphere
	echo "adding atmosphere..."
	ghr "$atmosphere" "atmosphere*.zip" "$tmpdir/atmosphere.zip"
	ghr "$atmosphere" "fusee.bin" "$tmpdir/fusee.bin"
	unzip -q "$tmpdir/atmosphere.zip" -d "$out"

	# then hekate
	echo "adding hekate..."
	ghr "$hekate" "hekate*.zip" "$tmpdir/hekate.zip"
	unzip -q "$tmpdir/hekate.zip" -d "$out"
	mv "$tmpdir/fusee.bin" "$out/bootloader/payloads/fusee.bin"
	mv $out/hekate*.bin "$out/bootloader/payloads/hekate.bin"
	cp "$resource_dir/hekate_ipl.ini" "$out/bootloader/hekate_ipl.ini"

	# then the sigpatches
	echo "adding sigpatches..."
	curl -o "$tmpdir/sigpatches.zip" "$sigpatches" 2>/dev/null
	unzip -q "$tmpdir/sigpatches.zip" -d "$out"

	# then dbi
	if test "$dflag"; then
		echo "adding DBI..."
		dbidir="$out/switch/DBI"
		mkdir -p "$dbidir"
		ghr "$dbi" "DBI.nro" "$dbidir/DBI.nro"
		ghr "$dbi" "dbi.config" "$dbidir/dbi.config"
	fi

	# then goldleaf
	if test "$gflag"; then
		echo "adding Goldleaf..."
		ghr "$goldleaf" "Goldleaf.nro" "$out/switch/Goldleaf.nro" "0.10"
	fi

	# then tinfoil
	if test "$nflag"; then
		echo "adding Tinfoil..."
		curl -L "$tinfoil" -o "$tmpdir/tinfoil.zip" 2>/dev/null
		unzip -q "$tmpdir/tinfoil.zip" -d "$out"
	fi

	# then lockpick
	if test "$lflag"; then
		echo "adding Lockpick_RCM..."
		ghr "$lockpick" "Lockpick_RCM.bin" "$out/bootloader/payloads/Lockpick_RCM.bin"
	fi

	# then tesla overlay and fastcfwswitch
	if test "$fflag"; then
		echo "adding fastCFWswitch..."
		if test -z "$tesla"; then
			ghr "$tesla" "ovlmenu.zip" "$tmpdir/ovlmenu.zip"
			unzip -q "$tmpdir/ovlmenu.zip" -d "$out"
		else
			mkdir -p "$out/switch/.overlays"
			ghr "$tesla" "ovlmenu.ovl" "$out/switch/.overlays/ovlmenu.ovl"
		fi
		ghr "$ovlloader" "nx-ovlloader.zip" "$tmpdir/nx-ovlloader.zip"
		ghr "$fastcfwswitch" "fastCFWswitch*.zip" "$tmpdir/fastCFWswitch.zip"
		unzip -q "$tmpdir/nx-ovlloader.zip" -d "$out"
		unzip -q "$tmpdir/fastCFWswitch.zip" -d "$out"
		cp "$resource_dir/fastCFWswitch.ini" "$out/config/fastCFWSwitch/config.ini"
	fi

	# then HDR
	if test "$hflag"; then
		echo "adding HDR..."
		ghr "$hdr" "switch-package.zip" "$tmpdir/hdr.zip"
		unzip -q "$tmpdir/hdr.zip" -d "$out"
		rm -r "$smash_dir/exefs"
		rm "$smash_dir/romfs/skyline/plugins/"*.nro

		echo "adding smashline_hook..."
		ghr "$smashline" "libsmashline_hook.nro" "$smash_dir/romfs/skyline/plugins/libsmashline_hook.nro"

		echo "adding ARCropolis workspaces..."
		arcropolis_dir="$out/ultimate/arcropolis/config/1154720435214108633/7988075541687562371"
		mkdir -p "$arcropolis_dir"
		cp "$resource_dir/hdr/workspace" "$arcropolis_dir"
		cp "$resource_dir/hdr/workspace_list" "$arcropolis_dir"
		cp "$resource_dir/hdr/preset" "$arcropolis_dir"
		cp "$resource_dir/hdr/HDR_preset2" "$arcropolis_dir"
	fi

	# then skyline
	echo "adding skyline..."
	ghr "$skyline" "skyline.zip" "$tmpdir/skyline.zip" "beta"
	if ! test -d "$smash_dir"; then
		mkdir -p "$smash_dir"
	fi
	unzip -q "$tmpdir/skyline.zip" -d "$smash_dir"

	# then arcropolis
	echo "adding ARCropolis..."
	ghr "$arcropolis" "release.zip" "$tmpdir/arcropolis.zip"
	unzip -q "$tmpdir/arcropolis.zip" -d "$out"

	# then wifi mod
	if test "$wflag"; then
		echo "adding WiFi mod..."
		ghr "$wifi" "release.zip" "$tmpdir/wifi.zip"
		unzip -q "$tmpdir/wifi.zip" -d "$out"
	fi

	# then training mod
	if test "$tflag"; then
		echo "adding training mod..."
		ghr "$training" "TrainingModpack.zip" "$tmpdir/training.zip"
		unzip -q "$tmpdir/training.zip" -d "$out"
	fi

	# then skin mods
	echo "adding skin mods..."
	if test -z "$mods_zip"; then
		curl -L "$mods_drive" -o "$tmpdir/mods.zip" 2>/dev/null
		unzip -q "$tmpdir/mods.zip" -d "$out"
	else
		unzip -q "$mods_zip" -d "$out"
	fi

	# then emuNAND
	if test "$eflag"; then
		echo "adding emuNAND..."
		cp "$resource_dir/emu/hekate_ipl.ini" "$out/bootloader/hekate_ipl.ini"
		if test "$fflag"; then
			cp "$resource_dir/emu/fastCFWswitch.ini" "$out/config/fastCFWSwitch/config.ini"
		fi

		echo "adding nintendo hosts blocking..."
		mkdir -p "$out/atmosphere/hosts"
		cp "$resource_dir/emu/hosts.txt" "$out/atmosphere/hosts/emummc.txt"
		cp "$resource_dir/emu/exosphere.ini" "$out/exosphere.ini"

	fi

	# then RetroArch
	if test "$rflag"; then
		echo "adding RetroArch..."
		curl -L "$retroarch" -o "$tmpdir/retroarch.7z" 2>/dev/null
		7za x "$tmpdir/retroarch.7z" -o"$out"
	fi

	# move out folder
	mv "$out" "$filename"

	# then zip
	if test "$zflag"; then
		echo "zipping folder..."
		zip --quiet -r "$filename.zip" "$filename"
		if test "$kflag"; then
			rm -r "$filename"
		fi
		echo "$filename.zip created!"
	else
		echo "$filename created!"
	fi

	# clean up temp folder
	if test "$cflag"; then
		rm -r "$tmpdir"
	fi
}

main "$@"
